<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Cambiar Contrase√±a - Anclora Kairon</title>
    <link rel="stylesheet" href="../src/shared/styles/auth-theme.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-text-center auth-mb-6">
                <h1 class="auth-title">üîê Cambiar Contrase√±a</h1>
                <p class="auth-subtitle">Ingresa tu nueva contrase√±a</p>
            </div>

            <!-- Status Messages -->
            <div id="status-container"></div>

            <!-- Reset Password Form -->
            <form id="reset-password-form">
                <div class="auth-form-group">
                    <label for="new-password" class="auth-label">Nueva Contrase√±a:</label>
                    <input 
                        type="password" 
                        id="new-password" 
                        name="password" 
                        required 
                        placeholder="Ingresa tu nueva contrase√±a"
                        autocomplete="new-password"
                        class="auth-input"
                    >
                    <div class="auth-password-requirements">
                        <div class="auth-requirement" id="req-length">
                            Al menos 8 caracteres
                        </div>
                        <div class="auth-requirement" id="req-uppercase">
                            Al menos una may√∫scula
                        </div>
                        <div class="auth-requirement" id="req-lowercase">
                            Al menos una min√∫scula
                        </div>
                        <div class="auth-requirement" id="req-number">
                            Al menos un n√∫mero
                        </div>
                    </div>
                </div>

                <div class="auth-form-group">
                    <label for="confirm-password" class="auth-label">Confirmar Contrase√±a:</label>
                    <input 
                        type="password" 
                        id="confirm-password" 
                        name="confirmPassword" 
                        required 
                        placeholder="Confirma tu nueva contrase√±a"
                        autocomplete="new-password"
                        class="auth-input"
                    >
                </div>

                <div class="auth-loading" id="loading">
                    <div class="auth-spinner"></div>
                    Cambiando contrase√±a...
                </div>

                <button type="submit" class="auth-btn auth-btn-primary auth-btn-full" id="submit-btn">
                    üîí Cambiar Contrase√±a
                </button>
            </form>

            <div class="auth-text-center auth-mt-4">
                <a href="../" class="auth-link">
                    ‚Üê Volver al inicio
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from '../src/shared/config/supabase.js';

        // Elementos del DOM
        const form = document.getElementById('reset-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const statusContainer = document.getElementById('status-container');

        // Elementos de requisitos
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqNumber = document.getElementById('req-number');

        // Verificar si hay una sesi√≥n v√°lida para reset
        async function checkResetSession() {
            try {
                console.log('üîç Verificando sesi√≥n de recuperaci√≥n...');
                console.log('URL actual:', window.location.href);
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                console.log('Sesi√≥n actual:', session);
                console.log('Error de sesi√≥n:', error);
                
                if (error) {
                    console.error('Error obteniendo sesi√≥n:', error);
                    throw error;
                }

                if (!session) {
                    console.log('‚ùå No hay sesi√≥n activa - enlace expirado');
                    
                    // Redirigir a la p√°gina de soluci√≥n de enlace expirado
                    setTimeout(() => {
                        window.location.href = '../enlace-expirado-solucion.html?error=session_expired';
                    }, 2000);
                    
                    showStatus('error', '‚è∞ Enlace Expirado', 
                        'El enlace de recuperaci√≥n ha expirado. Ser√°s redirigido a la p√°gina de soluci√≥n...'
                    );
                    
                    return false;
                }

                // Verificar que es una sesi√≥n v√°lida
                const urlParams = new URLSearchParams(window.location.search);
                const type = urlParams.get('type');
                
                console.log('Tipo de callback:', type);
                console.log('Email del usuario:', session.user?.email);
                
                if (type === 'recovery') {
                    showStatus('success', '‚úÖ Enlace v√°lido', `Sesi√≥n de recuperaci√≥n activa para: ${session.user?.email}`);
                } else {
                    showStatus('info', '‚ÑπÔ∏è Sesi√≥n activa detectada', `Puedes cambiar la contrase√±a para: ${session.user?.email}`);
                }

                return true;
            } catch (error) {
                console.error('Error checking reset session:', error);
                showStatus('error', '‚ùå Error de verificaci√≥n', 
                    `No se pudo verificar el enlace de recuperaci√≥n: ${error.message}\n\n` +
                    'Intenta solicitar un nuevo enlace.'
                );
                
                // Agregar bot√≥n para solicitar nuevo enlace
                setTimeout(() => {
                    statusContainer.innerHTML += `
                        <div class="mt-4 text-center">
                            <a href="../test-recuperacion-mejorada.html" class="btn btn-primary">
                                üìß Solicitar Nuevo Enlace
                            </a>
                        </div>
                    `;
                }, 2000);
                
                return false;
            }
        }

        // Mostrar mensajes de estado
        function showStatus(type, title, message) {
            statusContainer.innerHTML = `
                <div class="auth-status auth-status-${type}">
                    <div style="font-weight: 600;">${title}</div>
                    ${message ? `<div style="margin-top: 0.5rem; font-size: 0.875rem;">${message}</div>` : ''}
                </div>
            `;
        }

        // Validar contrase√±a en tiempo real
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password)
            };

            // Actualizar UI de requisitos
            reqLength.className = `auth-requirement ${requirements.length ? 'valid' : 'invalid'}`;
            reqUppercase.className = `auth-requirement ${requirements.uppercase ? 'valid' : 'invalid'}`;
            reqLowercase.className = `auth-requirement ${requirements.lowercase ? 'valid' : 'invalid'}`;
            reqNumber.className = `auth-requirement ${requirements.number ? 'valid' : 'invalid'}`;

            return Object.values(requirements).every(Boolean);
        }

        // Validar que las contrase√±as coincidan
        function validatePasswordMatch() {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword && password !== confirmPassword) {
                confirmPasswordInput.setCustomValidity('Las contrase√±as no coinciden');
                return false;
            } else {
                confirmPasswordInput.setCustomValidity('');
                return true;
            }
        }

        // Event listeners para validaci√≥n en tiempo real
        newPasswordInput.addEventListener('input', (e) => {
            const isValid = validatePassword(e.target.value);
            validatePasswordMatch();
            
            // Actualizar estado del bot√≥n
            const passwordsMatch = validatePasswordMatch();
            submitBtn.disabled = !isValid || !passwordsMatch;
        });

        confirmPasswordInput.addEventListener('input', () => {
            validatePasswordMatch();
            
            const isPasswordValid = validatePassword(newPasswordInput.value);
            const passwordsMatch = validatePasswordMatch();
            submitBtn.disabled = !isPasswordValid || !passwordsMatch;
        });

        // Manejar env√≠o del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Validaciones finales
            if (!validatePassword(password)) {
                showStatus('error', '‚ùå Contrase√±a inv√°lida', 'La contrase√±a no cumple con los requisitos de seguridad.');
                return;
            }

            if (password !== confirmPassword) {
                showStatus('error', '‚ùå Contrase√±as no coinciden', 'Las contrase√±as ingresadas no son iguales.');
                return;
            }

            // Mostrar loading
            submitBtn.disabled = true;
            loading.classList.add('show');
            statusContainer.innerHTML = '';

            try {
                console.log('üîí Cambiando contrase√±a...');

                // Cambiar contrase√±a usando Supabase
                const { data, error } = await supabase.auth.updateUser({
                    password: password
                });

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Contrase√±a cambiada exitosamente');

                // Mostrar √©xito
                showStatus('success', '‚úÖ Contrase√±a cambiada exitosamente', 'Tu contrase√±a ha sido actualizada. Ser√°s redirigido al inicio de sesi√≥n.');

                // Limpiar formulario
                form.reset();

                // Redirigir despu√©s de 3 segundos
                setTimeout(() => {
                    window.location.href = '../password-updated.html?message=password_updated';
                }, 3000);

            } catch (error) {
                console.error('‚ùå Error cambiando contrase√±a:', error);
                
                let errorMessage = 'Ocurri√≥ un error inesperado.';
                
                if (error.message.includes('session_not_found')) {
                    errorMessage = 'La sesi√≥n ha expirado. Solicita un nuevo enlace de recuperaci√≥n.';
                } else if (error.message.includes('same_password')) {
                    errorMessage = 'La nueva contrase√±a debe ser diferente a la actual.';
                } else if (error.message.includes('weak_password')) {
                    errorMessage = 'La contrase√±a no es lo suficientemente segura.';
                } else {
                    errorMessage = error.message;
                }

                showStatus('error', '‚ùå Error al cambiar contrase√±a', errorMessage);

            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });

        // Inicializar
        async function init() {
            console.log('üîê P√°gina de cambio de contrase√±a cargada');
            
            // Verificar sesi√≥n de reset
            const isValidSession = await checkResetSession();
            
            if (isValidSession) {
                showStatus('info', '‚úÖ Enlace v√°lido', 'Puedes proceder a cambiar tu contrase√±a.');
                newPasswordInput.focus();
            }

            // Validaci√≥n inicial
            submitBtn.disabled = true;
        }

        init();
    </script>
</body>
</html>