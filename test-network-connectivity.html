<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Network Connectivity Issues - Anclora</title>
    <link rel="stylesheet" href="src/shared/styles/userFeedback.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 120px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .status-display {
            background-color: #ecf0f1;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .network-status.online {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .network-status.offline {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .network-status.slow {
            background-color: #fef9e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .network-status.checking {
            background-color: #ebf3fd;
            color: #3498db;
            border: 1px solid #3498db;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.online {
            background-color: #27ae60;
        }

        .status-indicator.offline {
            background-color: #e74c3c;
        }

        .status-indicator.slow {
            background-color: #f39c12;
        }

        .status-indicator.checking {
            background-color: #3498db;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .log-entry.info {
            background-color: #e8f4f8;
            color: #2c3e50;
        }

        .log-entry.success {
            background-color: #d5f4e6;
            color: #27ae60;
        }

        .log-entry.error {
            background-color: #fadbd8;
            color: #e74c3c;
        }

        .log-entry.warning {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .connectivity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .offline-simulation {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .offline-simulation h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .offline-simulation p {
            margin: 0;
            color: #856404;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Test Network Connectivity Issues</h1>
            <p>Test authentication error handling when network connectivity is lost or degraded</p>
        </div>

        <!-- Network Status Display -->
        <div class="test-section">
            <h3>üìä Network Status Monitor</h3>
            <div id="networkStatus" class="network-status checking">
                <span class="status-indicator checking"></span>
                <span>Checking network status...</span>
            </div>
            
            <div class="connectivity-stats">
                <div class="stat-card">
                    <div class="stat-value" id="latencyValue">--</div>
                    <div class="stat-label">Latency (ms)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="queuedOpsValue">0</div>
                    <div class="stat-label">Queued Operations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="offlineTimeValue">--</div>
                    <div class="stat-label">Offline Duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="browserStatusValue">--</div>
                    <div class="stat-label">Browser Status</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="checkNetworkStatus()">Check Status</button>
                <button class="btn btn-secondary" onclick="forceConnectivityCheck()">Force Check</button>
                <button class="btn btn-warning" onclick="testSlowConnection()">Test Slow Connection</button>
            </div>
            <div class="status-display" id="networkDetails"></div>
        </div>

        <!-- Network Simulation Controls -->
        <div class="test-section">
            <h3>üé≠ Network Simulation Controls</h3>
            <div class="offline-simulation">
                <h4>‚ö†Ô∏è Offline Simulation</h4>
                <p>Note: These simulations work by modifying browser behavior. For real offline testing, use browser DevTools Network tab or disconnect your internet.</p>
            </div>
            
            <div class="button-group">
                <button class="btn btn-success" onclick="simulateOnline()">‚úÖ Simulate Online</button>
                <button class="btn btn-danger" onclick="simulateOffline()">‚ùå Simulate Offline</button>
                <button class="btn btn-warning" onclick="simulateSlowConnection()">üêå Simulate Slow</button>
                <button class="btn btn-secondary" onclick="simulateIntermittent()">üì∂ Simulate Intermittent</button>
            </div>
            <div class="status-display" id="simulationLog"></div>
        </div>

        <!-- Authentication Testing with Network Issues -->
        <div class="test-section">
            <h3>üîê Authentication Testing</h3>
            <p>Test authentication operations with different network connectivity scenarios</p>
            
            <div class="form-group">
                <label for="testEmail">Email:</label>
                <input type="email" id="testEmail" value="test@anclora.com" placeholder="Enter test email">
            </div>
            
            <div class="form-group">
                <label for="testPassword">Password:</label>
                <input type="password" id="testPassword" value="testpassword123" placeholder="Enter test password">
            </div>
            
            <div class="form-group">
                <label for="testName">Name (for registration):</label>
                <input type="text" id="testName" value="Test User" placeholder="Enter test name">
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="testLoginWithNetwork()">üîë Test Login</button>
                <button class="btn btn-primary" onclick="testRegisterWithNetwork()">üìù Test Register</button>
                <button class="btn btn-warning" onclick="testLoginOffline()">üîë Login Offline</button>
                <button class="btn btn-warning" onclick="testRegisterOffline()">üìù Register Offline</button>
            </div>
            
            <div class="status-display" id="authTestResults"></div>
        </div>

        <!-- Operation Queue Management -->
        <div class="test-section">
            <h3>üìã Network Operation Queue</h3>
            <p>Monitor and manage operations queued due to network connectivity issues</p>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="viewNetworkQueue()">üìä View Queue</button>
                <button class="btn btn-success" onclick="processNetworkQueue()">‚ñ∂Ô∏è Process Queue</button>
                <button class="btn btn-danger" onclick="clearNetworkQueue()">üóëÔ∏è Clear Queue</button>
                <button class="btn btn-secondary" onclick="addNetworkTestOperation()">‚ûï Add Test Operation</button>
            </div>
            
            <div class="status-display" id="networkQueueLog"></div>
        </div>

        <!-- Offline Indicators Testing -->
        <div class="test-section">
            <h3>üö® Offline Indicators Testing</h3>
            <p>Test offline indicators and UI feedback when network is unavailable</p>
            
            <div class="button-group">
                <button class="btn btn-warning" onclick="showOfflineIndicators()">üö® Show Offline UI</button>
                <button class="btn btn-success" onclick="hideOfflineIndicators()">‚úÖ Hide Offline UI</button>
                <button class="btn btn-secondary" onclick="testFormDisabling()">üìù Test Form Disabling</button>
                <button class="btn btn-primary" onclick="testOfflineBanner()">üì¢ Test Offline Banner</button>
            </div>
            
            <div class="status-display" id="indicatorTestResults"></div>
        </div>

        <!-- Automatic Retry Testing -->
        <div class="test-section">
            <h3>üîÑ Network Retry Testing</h3>
            <p>Test automatic retry functionality when network connection is restored</p>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="testNetworkRetry()">üîÑ Test Network Retry</button>
                <button class="btn btn-warning" onclick="simulateConnectionRestored()">üîß Simulate Restoration</button>
                <button class="btn btn-secondary" onclick="testRetryBackoff()">‚è±Ô∏è Test Backoff</button>
                <button class="btn btn-danger" onclick="testRetryFailure()">‚ùå Test Retry Failure</button>
            </div>
            
            <div class="status-display" id="retryTestResults"></div>
        </div>

        <!-- Event Log -->
        <div class="test-section">
            <h3>üìù Network Event Log</h3>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="clearNetworkEventLog()">üóëÔ∏è Clear Log</button>
                <button class="btn btn-primary" onclick="exportNetworkEventLog()">üíæ Export Log</button>
            </div>
            <div class="status-display" id="networkEventLog"></div>
        </div>
    </div>

    <!-- User Feedback Container -->
    <div id="userFeedbackContainer"></div>

    <script type="module">
        import { authService } from './src/shared/services/authService.js';
        import { networkConnectivityHandler } from './src/shared/services/networkConnectivityHandler.js';
        import { userFeedbackSystem } from './src/shared/services/userFeedbackSystem.js';

        // Global variables for testing
        window.authService = authService;
        window.networkConnectivityHandler = networkConnectivityHandler;
        window.userFeedbackSystem = userFeedbackSystem;

        let eventLogEntries = [];
        let statusUpdateInterval = null;

        // Initialize user feedback system
        userFeedbackSystem.initialize();

        // Event logging function
        function logEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                message,
                type,
                id: Date.now() + Math.random()
            };
            
            eventLogEntries.unshift(entry);
            
            // Keep only last 100 entries
            if (eventLogEntries.length > 100) {
                eventLogEntries = eventLogEntries.slice(0, 100);
            }
            
            updateNetworkEventLog();
        }

        function updateNetworkEventLog() {
            const eventLog = document.getElementById('networkEventLog');
            eventLog.innerHTML = eventLogEntries
                .map(entry => `<div class="log-entry ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`)
                .join('');
        }

        // Network status functions
        window.checkNetworkStatus = async function() {
            logEvent('Checking network status...', 'info');
            
            try {
                const result = await networkConnectivityHandler.checkNetworkConnectivity();
                const networkStatus = networkConnectivityHandler.getNetworkStatus();
                
                updateNetworkStatusDisplay(result, networkStatus);
                logEvent(`Network status: ${result.status} - ${result.isOnline ? 'Online' : 'Offline'}`, 
                    result.isOnline ? 'success' : 'error');
                
                document.getElementById('networkDetails').textContent = JSON.stringify({
                    connectivity: result,
                    networkStatus: networkStatus
                }, null, 2);
                
            } catch (error) {
                logEvent(`Error checking network status: ${error.message}`, 'error');
                console.error('Error checking network status:', error);
            }
        };

        function updateNetworkStatusDisplay(connectivityResult, networkStatus) {
            const statusElement = document.getElementById('networkStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            // Update main status
            if (connectivityResult.isOnline) {
                if (networkStatus.status === 'SLOW') {
                    statusElement.className = 'network-status slow';
                    indicator.className = 'status-indicator slow';
                    text.textContent = `Network Slow (${connectivityResult.latency}ms)`;
                } else {
                    statusElement.className = 'network-status online';
                    indicator.className = 'status-indicator online';
                    text.textContent = `Network Online (${connectivityResult.latency}ms)`;
                }
            } else {
                statusElement.className = 'network-status offline';
                indicator.className = 'status-indicator offline';
                text.textContent = 'Network Offline';
            }

            // Update stats
            document.getElementById('latencyValue').textContent = 
                connectivityResult.latency ? `${connectivityResult.latency}` : '--';
            document.getElementById('queuedOpsValue').textContent = networkStatus.queuedOperationsCount;
            document.getElementById('browserStatusValue').textContent = 
                networkStatus.browserOnline ? 'Online' : 'Offline';
            
            // Update offline duration
            if (networkStatus.offlineStartTime) {
                const duration = Math.round((Date.now() - new Date(networkStatus.offlineStartTime).getTime()) / 1000);
                document.getElementById('offlineTimeValue').textContent = `${duration}s`;
            } else {
                document.getElementById('offlineTimeValue').textContent = '--';
            }
        }

        window.forceConnectivityCheck = async function() {
            logEvent('Forcing connectivity check...', 'info');
            await checkNetworkStatus();
        };

        window.testSlowConnection = function() {
            logEvent('Testing slow connection detection...', 'info');
            // This would require actual network throttling
            userFeedbackSystem.showWarning('Slow connection test requires network throttling in DevTools');
        };

        // Network simulation functions
        window.simulateOnline = function() {
            logEvent('Simulating online status', 'info');
            // Trigger online event
            window.dispatchEvent(new Event('online'));
            userFeedbackSystem.showSuccess('Network simulation: Online');
        };

        window.simulateOffline = function() {
            logEvent('Simulating offline status', 'warning');
            // Trigger offline event
            window.dispatchEvent(new Event('offline'));
            userFeedbackSystem.showError('Network simulation: Offline');
        };

        window.simulateSlowConnection = function() {
            logEvent('Simulating slow connection', 'warning');
            userFeedbackSystem.showWarning('Network simulation: Slow Connection');
        };

        window.simulateIntermittent = function() {
            logEvent('Simulating intermittent connection', 'warning');
            
            // Simulate intermittent connectivity
            let isOnline = true;
            const interval = setInterval(() => {
                if (isOnline) {
                    window.dispatchEvent(new Event('offline'));
                    logEvent('Intermittent: Going offline', 'warning');
                } else {
                    window.dispatchEvent(new Event('online'));
                    logEvent('Intermittent: Coming online', 'success');
                }
                isOnline = !isOnline;
            }, 3000);

            // Stop after 15 seconds
            setTimeout(() => {
                clearInterval(interval);
                window.dispatchEvent(new Event('online'));
                logEvent('Intermittent simulation ended', 'info');
            }, 15000);

            userFeedbackSystem.showInfo('Network simulation: Intermittent (15s)');
        };

        // Authentication testing functions
        window.testLoginWithNetwork = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !password) {
                logEvent('Please enter email and password', 'warning');
                return;
            }
            
            logEvent(`Testing login with network handling for ${email}`, 'info');
            
            try {
                const result = await authService.loginWithConnectivityHandling(email, password, {
                    allowQueue: true,
                    showFeedback: true
                });
                
                if (result.success || result.user) {
                    logEvent(`Login with network handling successful for ${email}`, 'success');
                } else {
                    logEvent(`Login with network handling failed: ${result.error?.userMessage || 'Unknown error'}`, 'error');
                }
                
                document.getElementById('authTestResults').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Login with network handling error: ${error.message}`, 'error');
                document.getElementById('authTestResults').textContent = `Error: ${error.message}`;
            }
        };

        window.testRegisterWithNetwork = async function() {
            const name = document.getElementById('testName').value;
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!name || !email || !password) {
                logEvent('Please enter name, email and password', 'warning');
                return;
            }
            
            logEvent(`Testing registration with network handling for ${email}`, 'info');
            
            try {
                const result = await authService.registerWithConnectivityHandling(name, email, password, {
                    allowQueue: true,
                    showFeedback: true
                });
                
                if (result.success || result.user) {
                    logEvent(`Registration with network handling successful for ${email}`, 'success');
                } else {
                    logEvent(`Registration with network handling failed: ${result.error?.userMessage || 'Unknown error'}`, 'error');
                }
                
                document.getElementById('authTestResults').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Registration with network handling error: ${error.message}`, 'error');
                document.getElementById('authTestResults').textContent = `Error: ${error.message}`;
            }
        };

        window.testLoginOffline = async function() {
            // First simulate offline
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(async () => {
                await testLoginWithNetwork();
            }, 1000);
        };

        window.testRegisterOffline = async function() {
            // First simulate offline
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(async () => {
                await testRegisterWithNetwork();
            }, 1000);
        };

        // Queue management functions
        window.viewNetworkQueue = function() {
            const networkStatus = networkConnectivityHandler.getNetworkStatus();
            
            document.getElementById('networkQueueLog').textContent = JSON.stringify(networkStatus, null, 2);
            logEvent(`Network queue status: ${networkStatus.queuedOperationsCount} operations queued`, 'info');
        };

        window.processNetworkQueue = async function() {
            logEvent('Attempting to process network queue...', 'info');
            
            try {
                const result = await networkConnectivityHandler.forceConnectivityCheck();
                
                if (result.isOnline) {
                    logEvent('Network is online, queue should process automatically', 'success');
                } else {
                    logEvent('Network still offline, queue cannot be processed', 'warning');
                }
                
                document.getElementById('networkQueueLog').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Error processing network queue: ${error.message}`, 'error');
            }
        };

        window.clearNetworkQueue = function() {
            try {
                const clearedCount = networkConnectivityHandler.clearQueue();
                logEvent(`Cleared ${clearedCount} operations from network queue`, 'info');
                
            } catch (error) {
                logEvent(`Error clearing network queue: ${error.message}`, 'error');
            }
        };

        window.addNetworkTestOperation = async function() {
            try {
                const testOperation = async () => {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return { success: true, message: 'Network test operation completed' };
                };
                
                const result = await networkConnectivityHandler.queueOperation(testOperation, {
                    operation: 'network_test_operation',
                    timestamp: new Date().toISOString()
                });
                
                logEvent('Network test operation added to queue', 'info');
                document.getElementById('networkQueueLog').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Error adding network test operation: ${error.message}`, 'error');
            }
        };

        // Offline indicators testing
        window.showOfflineIndicators = function() {
            logEvent('Showing offline indicators...', 'info');
            networkConnectivityHandler.showOfflineIndicator();
        };

        window.hideOfflineIndicators = function() {
            logEvent('Hiding offline indicators...', 'info');
            networkConnectivityHandler.hideOfflineIndicators();
        };

        window.testFormDisabling = function() {
            logEvent('Testing form disabling for offline state...', 'info');
            document.body.classList.toggle('network-offline');
            
            const isOffline = document.body.classList.contains('network-offline');
            userFeedbackSystem.showInfo(`Forms ${isOffline ? 'disabled' : 'enabled'} for offline state`);
        };

        window.testOfflineBanner = function() {
            logEvent('Testing offline banner...', 'info');
            
            // Create or toggle offline banner
            let banner = document.getElementById('network-offline-banner');
            if (banner) {
                banner.remove();
                logEvent('Offline banner removed', 'info');
            } else {
                networkConnectivityHandler.addOfflineIndicatorToElements();
                logEvent('Offline banner added', 'info');
            }
        };

        // Retry testing functions
        window.testNetworkRetry = async function() {
            logEvent('Testing network retry functionality...', 'info');
            
            let attempt = 0;
            const maxAttempts = 3;
            
            const testRetryOperation = async () => {
                attempt++;
                
                if (attempt < 3) {
                    throw new Error(`Network retry test - attempt ${attempt} failed`);
                }
                
                return { success: true, attempts: attempt };
            };
            
            try {
                const result = await testRetryOperation();
                logEvent(`Network retry test completed successfully after ${result.attempts} attempts`, 'success');
                document.getElementById('retryTestResults').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Network retry test failed: ${error.message}`, 'error');
                document.getElementById('retryTestResults').textContent = `Error: ${error.message}`;
            }
        };

        window.simulateConnectionRestored = function() {
            logEvent('Simulating network connection restoration...', 'info');
            
            // Trigger online event
            window.dispatchEvent(new Event('online'));
            userFeedbackSystem.showSuccess('Network simulation: Connection Restored');
            
            // Trigger a status check
            setTimeout(checkNetworkStatus, 1000);
        };

        window.testRetryBackoff = async function() {
            logEvent('Testing exponential backoff for network retry...', 'info');
            
            let attempt = 0;
            const maxAttempts = 4;
            const baseDelay = 1000;
            
            const retryWithBackoff = async () => {
                for (let i = 0; i < maxAttempts; i++) {
                    attempt++;
                    
                    try {
                        if (attempt < 3) {
                            throw new Error(`Network backoff test - attempt ${attempt} failed`);
                        }
                        
                        logEvent(`Network retry successful on attempt ${attempt}`, 'success');
                        return { success: true, attempts: attempt };
                        
                    } catch (error) {
                        const delay = baseDelay * Math.pow(2, i);
                        logEvent(`Network attempt ${attempt} failed, retrying in ${delay}ms`, 'warning');
                        
                        if (i < maxAttempts - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error;
                        }
                    }
                }
            };
            
            try {
                const result = await retryWithBackoff();
                document.getElementById('retryTestResults').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                logEvent(`Network retry with backoff failed: ${error.message}`, 'error');
                document.getElementById('retryTestResults').textContent = `Error: ${error.message}`;
            }
        };

        window.testRetryFailure = async function() {
            logEvent('Testing network retry failure scenario...', 'info');
            
            const failingOperation = async () => {
                throw new Error('Network operation consistently failing');
            };
            
            try {
                await failingOperation();
            } catch (error) {
                logEvent(`Network retry failure test: ${error.message}`, 'error');
                document.getElementById('retryTestResults').textContent = `Expected failure: ${error.message}`;
            }
        };

        // Event log functions
        window.clearNetworkEventLog = function() {
            eventLogEntries = [];
            updateNetworkEventLog();
            logEvent('Network event log cleared', 'info');
        };

        window.exportNetworkEventLog = function() {
            const logData = eventLogEntries.map(entry => 
                `[${entry.timestamp}] ${entry.type.toUpperCase()}: ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `network-connectivity-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            logEvent('Network event log exported', 'success');
        };

        // Set up event listeners for network status changes
        networkConnectivityHandler.addEventListener('networkStatusChange', (event) => {
            logEvent(`Network status changed: ${event.from} ‚Üí ${event.to}`, 'info');
            checkNetworkStatus(); // Update display
        });

        networkConnectivityHandler.addEventListener('connectivityLost', (event) => {
            logEvent('Network connectivity lost', 'error');
        });

        networkConnectivityHandler.addEventListener('connectivityRestored', (event) => {
            logEvent(`Network connectivity restored after ${Math.round(event.offlineDuration / 1000)}s`, 'success');
        });

        networkConnectivityHandler.addEventListener('connectivityCheck', (event) => {
            // Update stats in real-time
            updateNetworkStatusDisplay(event, networkConnectivityHandler.getNetworkStatus());
        });

        // Start periodic status updates
        function startStatusUpdates() {
            statusUpdateInterval = setInterval(() => {
                const networkStatus = networkConnectivityHandler.getNetworkStatus();
                
                // Update stats without full check
                document.getElementById('queuedOpsValue').textContent = networkStatus.queuedOperationsCount;
                document.getElementById('browserStatusValue').textContent = 
                    networkStatus.browserOnline ? 'Online' : 'Offline';
                
                if (networkStatus.offlineStartTime) {
                    const duration = Math.round((Date.now() - new Date(networkStatus.offlineStartTime).getTime()) / 1000);
                    document.getElementById('offlineTimeValue').textContent = `${duration}s`;
                }
            }, 1000);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            logEvent('Network Connectivity Test Page initialized', 'info');
            checkNetworkStatus();
            startStatusUpdates();
        });

        // Log initial message
        logEvent('Network connectivity test page loaded and ready', 'success');
    </script>
</body>
</html>