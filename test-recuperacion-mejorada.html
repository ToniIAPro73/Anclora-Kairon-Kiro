<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 Prueba: Recuperación de Contraseña Mejorada</title>
    <link rel="stylesheet" href="src/shared/styles/auth-theme.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-text-center auth-mb-6">
                <h1 class="auth-title">🔐 Recuperación de Contraseña Mejorada</h1>
                <p class="auth-subtitle">Prueba la nueva funcionalidad con diagnósticos completos</p>
            </div>

            <form id="recovery-form">
                <div class="auth-form-group">
                    <label for="email" class="auth-label">Email:</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="tu@email.com"
                        autocomplete="email"
                        class="auth-input"
                    >
                </div>

                <button type="submit" class="auth-btn auth-btn-primary auth-btn-full" id="submit-btn">
                    📧 Enviar enlace de recuperación
                </button>
            </form>

            <div id="loading" class="auth-loading">
                <div class="auth-spinner"></div>
                Enviando email de recuperación...
            </div>

            <div id="result-container" class="auth-mt-4" style="display: none;">
                <!-- Los resultados se mostrarán aquí -->
            </div>

            <div class="auth-info-box auth-info-box-info auth-mt-6">
                <h3 class="auth-section-title">📋 ¿Qué hace esta prueba?</h3>
                <ul class="auth-text">
                    <li>✅ Verifica la conectividad con Supabase</li>
                    <li>🔍 Ejecuta diagnósticos técnicos completos</li>
                    <li>📧 Intenta enviar el email de recuperación</li>
                    <li>📊 Muestra información detallada del resultado</li>
                    <li>💡 Proporciona instrucciones específicas sobre dónde buscar el email</li>
                    <li>🛠️ Incluye información técnica para soporte</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Elementos del DOM
        const form = document.getElementById('recovery-form');
        const emailInput = document.getElementById('email');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');

        // Manejar envío del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            if (!email) {
                alert('Por favor ingresa tu email');
                return;
            }

            // Mostrar estado de carga
            submitBtn.disabled = true;
            loading.classList.add('show');
            resultContainer.style.display = 'none';

            try {
                console.log('🔐 Iniciando recuperación mejorada para:', email);
                
                // Importar authService dinámicamente
                const { authService } = await import('./src/shared/services/authService.js');
                
                // Llamar a la función mejorada de reset de contraseña
                const result = await authService.resetPassword(email, {
                    language: 'es',
                    enableDiagnostics: true
                });

                console.log('📧 Resultado completo:', result);

                // Mostrar resultado detallado
                showDetailedResult(result, email);

            } catch (error) {
                console.error('❌ Error inesperado:', error);
                
                // Mostrar error genérico
                showErrorResult(error, email);
            } finally {
                // Ocultar estado de carga
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });

        function showDetailedResult(result, email) {
            resultContainer.style.display = 'block';
            
            if (result.success) {
                resultContainer.innerHTML = `
                    <div class="auth-status auth-status-success">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">✅ Email enviado exitosamente</h3>
                        <p class="auth-text"><strong>Email enviado a:</strong> ${email}</p>
                        <p class="auth-text"><strong>Mensaje:</strong> ${result.message}</p>
                    </div>
                    
                    <div class="auth-info-box auth-info-box-success auth-mt-4">
                        <h4 class="auth-section-title">📧 Instrucciones importantes:</h4>
                        <ul class="auth-text">
                            ${result.instructions ? result.instructions.map(instruction => `<li>${instruction}</li>`).join('') : '<li>Revisa tu bandeja de entrada y carpeta de spam</li>'}
                        </ul>
                    </div>

                    <div class="auth-info-box auth-info-box-warning auth-mt-4">
                        <h4 class="auth-section-title">⚠️ MUY IMPORTANTE</h4>
                        <p class="auth-text">Si no ves el email en 2-3 minutos, <strong>revisa tu carpeta de SPAM</strong>. Esta es la causa más común de emails "perdidos".</p>
                        <div class="auth-mt-4">
                            <button class="auth-btn auth-btn-secondary" onclick="showEmailGuide('${email}')">
                                🔍 Guía: ¿Dónde buscar el email?
                            </button>
                        </div>
                    </div>

                    ${result.diagnostics ? `
                        <details class="auth-mt-4" style="background: var(--auth-bg-secondary); padding: 1rem; border-radius: 8px; border: 1px solid var(--auth-border);">
                            <summary style="cursor: pointer; font-weight: 500; color: var(--auth-text-primary);">🔧 Información técnica (para soporte)</summary>
                            <pre style="background: var(--auth-bg-primary); padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.75rem; color: var(--auth-text-secondary); margin: 0.5rem 0 0 0;">${JSON.stringify(result.diagnostics, null, 2)}</pre>
                        </details>
                    ` : ''}

                    <div class="auth-text-center auth-mt-4">
                        <button class="auth-btn auth-btn-primary" onclick="location.reload()">
                            🔄 Probar con otro email
                        </button>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="auth-status auth-status-error">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">❌ No se pudo enviar el email</h3>
                        <p class="auth-text"><strong>Error:</strong> ${result.error.message}</p>
                        <p class="auth-text"><strong>Tipo de error:</strong> ${result.error.type}</p>
                    </div>
                    
                    <div class="auth-info-box auth-info-box-error auth-mt-4">
                        <h4 class="auth-section-title">💡 Soluciones recomendadas:</h4>
                        <ul class="auth-text">
                            ${result.troubleshooting ? result.troubleshooting.map(step => `<li>${step}</li>`).join('') : '<li>Verifica que el email esté correcto e intenta nuevamente</li>'}
                        </ul>
                    </div>

                    ${result.diagnostics ? `
                        <details class="auth-mt-4" style="background: var(--auth-bg-secondary); padding: 1rem; border-radius: 8px; border: 1px solid var(--auth-error-border);">
                            <summary style="cursor: pointer; font-weight: 500; color: var(--auth-text-primary);">🔧 Información para soporte técnico</summary>
                            <pre style="background: var(--auth-bg-primary); padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.75rem; color: var(--auth-text-secondary); margin: 0.5rem 0 0 0;">${JSON.stringify(result.diagnostics, null, 2)}</pre>
                        </details>
                    ` : ''}

                    <div class="auth-text-center auth-mt-4">
                        <div class="auth-grid auth-grid-2">
                            <button class="auth-btn auth-btn-primary" onclick="location.reload()">
                                🔄 Intentar nuevamente
                            </button>
                            <button class="auth-btn auth-btn-secondary" onclick="contactSupport('${email}', '${result.error.type}')">
                                📞 Contactar soporte
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function showErrorResult(error, email) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = `
                <div class="auth-status auth-status-error">
                    <h3 style="font-weight: 600; margin-bottom: 0.5rem;">❌ Error inesperado</h3>
                    <p class="auth-text"><strong>Error:</strong> ${error.message}</p>
                </div>
                
                <div class="auth-info-box auth-info-box-error auth-mt-4">
                    <h4 class="auth-section-title">💡 Posibles causas:</h4>
                    <ul class="auth-text">
                        <li>Problema de configuración de Supabase</li>
                        <li>Error de conectividad</li>
                        <li>Variables de entorno no configuradas</li>
                    </ul>
                </div>

                <div style="background: var(--auth-bg-secondary); padding: 1rem; border-radius: 8px; border: 1px solid var(--auth-error-border); margin-top: 1rem;">
                    <strong class="auth-text">Información del error:</strong><br>
                    <pre style="font-size: 0.75rem; color: var(--auth-text-secondary); margin: 0.5rem 0 0 0; white-space: pre-wrap;">${error.stack || error.message}</pre>
                </div>

                <div class="auth-text-center auth-mt-4">
                    <div class="auth-grid auth-grid-2">
                        <button class="auth-btn auth-btn-primary" onclick="location.reload()">
                            🔄 Intentar nuevamente
                        </button>
                        <button class="auth-btn auth-btn-secondary" onclick="contactSupport('${email}', 'UNEXPECTED_ERROR')">
                            📞 Contactar soporte
                        </button>
                    </div>
                </div>
            `;
        }

        // Función para mostrar guía de email
        window.showEmailGuide = function(email) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 1rem;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--auth-bg-primary); border: 2px solid var(--auth-border); border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--auth-text-primary); font-size: 1.25rem; font-weight: 600; margin: 0;">🔍 ¿Dónde buscar tu email de recuperación?</h3>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: var(--auth-bg-secondary); border: 2px solid var(--auth-border); color: var(--auth-text-primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                    
                    <p style="color: var(--auth-text-secondary); margin-bottom: 1rem;"><strong>Email enviado a:</strong> ${email}</p>
                    
                    <div style="margin: 1rem 0;">
                        <h4 style="color: var(--auth-text-primary); font-weight: 600; margin-bottom: 0.5rem;">📥 1. Bandeja de entrada principal</h4>
                        <p style="color: var(--auth-text-secondary); font-size: 0.875rem;">Busca un email de <code style="background: var(--auth-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; color: var(--auth-accent);">noreply@supabase.co</code></p>
                    </div>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <h4 style="color: var(--auth-warning); font-weight: 600; margin-bottom: 0.5rem;">🚨 2. Carpeta de SPAM (MUY IMPORTANTE)</h4>
                        <p style="color: var(--auth-text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Esta es la causa más común. Revisa:</p>
                        <ul style="color: var(--auth-text-secondary); font-size: 0.875rem; margin: 0; padding-left: 1.25rem;">
                            <li>Spam / Correo no deseado</li>
                            <li>Correo basura</li>
                            <li>Quarantine</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <h4 style="color: var(--auth-text-primary); font-weight: 600; margin-bottom: 0.5rem;">📂 3. Otras carpetas (Gmail)</h4>
                        <ul style="color: var(--auth-text-secondary); font-size: 0.875rem; margin: 0; padding-left: 1.25rem;">
                            <li>Promociones</li>
                            <li>Actualizaciones</li>
                            <li>Social</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <h4 style="color: var(--auth-text-primary); font-weight: 600; margin-bottom: 0.5rem;">🔍 4. Buscar directamente</h4>
                        <p style="color: var(--auth-text-secondary); font-size: 0.875rem;">Busca en tu email: <code style="background: var(--auth-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; color: var(--auth-accent);">Anclora</code> o <code style="background: var(--auth-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; color: var(--auth-accent);">recuperación</code></p>
                    </div>
                    
                    <div style="background: rgba(14, 165, 233, 0.1); border: 2px solid rgba(14, 165, 233, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <h4 style="color: var(--auth-info); font-weight: 600; margin-bottom: 0.5rem;">💡 Para evitar esto en el futuro:</h4>
                        <ul style="color: var(--auth-text-secondary); font-size: 0.875rem; margin: 0; padding-left: 1.25rem;">
                            <li>Agrega <code style="background: rgba(14, 165, 233, 0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: var(--auth-info);">noreply@supabase.co</code> a tus contactos</li>
                            <li>Marca como "No es spam" si lo encuentras en spam</li>
                            <li>Configura filtros para permitir emails de Supabase</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button onclick="this.closest('div').parentElement.remove()" class="auth-btn auth-btn-primary">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        // Función para contactar soporte
        window.contactSupport = function(email, errorType) {
            const subject = encodeURIComponent('No llega email de recuperación de contraseña');
            const body = encodeURIComponent(`
Hola,

No me está llegando el email para recuperar mi contraseña usando la nueva funcionalidad mejorada.

Detalles:
- Email: ${email}
- Tipo de error: ${errorType}
- Hora del intento: ${new Date().toLocaleString()}
- Navegador: ${navigator.userAgent}
- URL de prueba: ${window.location.href}

He probado la funcionalidad mejorada con diagnósticos y el resultado está en la consola del navegador.

Por favor, ayúdenme a resolver este problema.

Gracias.
            `);
            
            window.open(`mailto:soporte@anclora.com?subject=${subject}&body=${body}`);
        };

        // Auto-focus en el campo de email
        emailInput.focus();

        // Mostrar información de configuración en consola
        console.log('🔧 Configuración actual:');
        console.log('- Supabase URL:', import.meta.env?.VITE_SUPABASE_URL);
        console.log('- Supabase Key configurada:', !!import.meta.env?.VITE_SUPABASE_ANON_KEY);
        console.log('- Página de prueba cargada correctamente');
    </script>
</body>
</html>