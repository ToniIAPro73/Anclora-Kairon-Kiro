<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Completo Auth + Onboarding - Anclora Kairon</title>
    <link rel="stylesheet" href="src/shared/styles/auth-theme.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card auth-card-large">
            <!-- Header -->
            <div class="auth-text-center auth-mb-8">
                <div style="width: 80px; height: 80px; margin: 0 auto 1rem auto; background: linear-gradient(90deg, #2EAFC4 0%, #FFC979 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 40px; height: 40px; color: #162032;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h1 class="auth-title">Test Completo: Auth + Onboarding</h1>
                <p class="auth-subtitle">Prueba el flujo completo de autenticación y onboarding</p>
            </div>

            <!-- Quick Test Section -->
            <div class="auth-info-box auth-info-box-success auth-mb-6">
                <h2 class="auth-section-title">🚀 Prueba Rápida</h2>
                <p class="auth-text auth-mb-4">
                    Prueba el flujo completo: Registro → Login → Onboarding
                </p>
                <div class="auth-grid auth-grid-3">
                    <button id="quick-register" class="auth-btn auth-btn-primary">
                        1️⃣ Registro Rápido
                    </button>
                    <button id="quick-login" class="auth-btn auth-btn-primary">
                        2️⃣ Login Test
                    </button>
                    <button id="quick-onboarding" class="auth-btn auth-btn-primary">
                        3️⃣ Onboarding
                    </button>
                </div>
                <div class="auth-info-box auth-info-box-info auth-mt-4">
                    <p class="auth-text">
                        <strong>Flujo recomendado:</strong> Haz clic en orden 1→2→3 para probar todo el sistema
                    </p>
                </div>
            </div>

            <!-- Status Check -->
            <div class="auth-info-box auth-info-box-warning auth-mb-6">
                <h2 class="auth-section-title">📊 Estado del Sistema</h2>
                <div class="auth-grid auth-grid-2">
                    <div>
                        <h3 class="auth-text" style="font-weight: 600; margin-bottom: 0.75rem;">Configuración</h3>
                        <div class="auth-space-y-2">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Supabase:</span>
                                <span id="supabase-status" class="status-error">❌ No configurado</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Google OAuth:</span>
                                <span id="google-status" class="status-warning">⚠️ Opcional</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>GitHub OAuth:</span>
                                <span id="github-status" class="status-warning">⚠️ Opcional</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="auth-text" style="font-weight: 600; margin-bottom: 0.75rem;">Usuario Actual</h3>
                        <div class="auth-space-y-2">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Autenticado:</span>
                                <span id="auth-status" class="status-error">❌ No</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Usuario nuevo:</span>
                                <span id="new-user-status" class="status-error">❌ No</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Onboarding:</span>
                                <span id="onboarding-status" class="status-error">❌ Pendiente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Forms -->
            <div class="auth-grid auth-grid-2 auth-mb-6">
                <!-- Register -->
                <div class="auth-info-box auth-info-box-info">
                    <h2 class="auth-section-title">📝 Registro Manual</h2>
                    <form id="register-form" class="auth-space-y-4">
                        <input type="text" id="reg-name" class="auth-input" placeholder="Tu nombre" required>
                        <input type="email" id="reg-email" class="auth-input" placeholder="tu@email.com" required>
                        <input type="password" id="reg-password" class="auth-input" placeholder="Contraseña (min 6)" required>
                        <button type="submit" class="auth-btn auth-btn-primary auth-btn-full">Crear Cuenta</button>
                    </form>
                </div>

                <!-- Login -->
                <div class="auth-info-box auth-info-box-success">
                    <h2 class="auth-section-title">🔑 Login Manual</h2>
                    <form id="login-form" class="auth-space-y-4">
                        <input type="email" id="login-email" class="auth-input" placeholder="tu@email.com" required>
                        <input type="password" id="login-password" class="auth-input" placeholder="Tu contraseña" required>
                        <button type="submit" class="auth-btn auth-btn-primary auth-btn-full">Iniciar Sesión</button>
                    </form>
                    
                    <!-- OAuth Buttons -->
                    <div class="auth-mt-6" style="padding-top: 1.5rem; border-top: 1px solid rgba(46, 175, 196, 0.3);">
                        <div class="auth-grid auth-grid-2">
                            <button id="google-btn" class="auth-btn auth-btn-secondary">🔍 Google</button>
                            <button id="github-btn" class="auth-btn auth-btn-secondary">🐙 GitHub</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="auth-info-box auth-info-box-warning auth-mb-6">
                <h2 class="auth-section-title">⚡ Acciones</h2>
                <div class="auth-grid auth-grid-4">
                    <button id="test-onboarding" class="auth-btn auth-btn-secondary">🚀 Onboarding</button>
                    <button id="logout-btn" class="auth-btn auth-btn-secondary">🚪 Logout</button>
                    <button id="reset-data" class="auth-btn auth-btn-secondary">🔄 Reset</button>
                    <button id="check-db" class="auth-btn auth-btn-secondary">🗄️ Check DB</button>
                </div>
            </div>

            <!-- Error Testing Section -->
            <div class="auth-info-box auth-info-box-error auth-mb-6">
                <h2 class="auth-section-title">🧪 Pruebas de Error</h2>
                <p class="auth-text auth-mb-4">
                    Simula diferentes escenarios de error para probar el sistema de manejo de errores
                </p>
                <div class="auth-grid auth-grid-3">
                    <button id="test-network-error" class="auth-btn auth-btn-secondary">
                        📡 Error Red
                    </button>
                    <button id="test-invalid-creds" class="auth-btn auth-btn-secondary">
                        🔐 Credenciales Inválidas
                    </button>
                    <button id="test-user-exists" class="auth-btn auth-btn-secondary">
                        👤 Usuario Existe
                    </button>
                    <button id="test-weak-password" class="auth-btn auth-btn-secondary">
                        🔒 Contraseña Débil
                    </button>
                    <button id="test-connectivity" class="auth-btn auth-btn-secondary">
                        🌐 Test Conectividad
                    </button>
                    <button id="clear-all-errors" class="auth-btn auth-btn-secondary">
                        ✨ Limpiar Todo
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages" class="auth-space-y-4"></div>
        </div>
    </div>
</body>
</html>    <scri
pt type="module">
        import { authService } from './src/shared/services/authService.js';
        import { onboardingWizard } from './src/shared/components/OnboardingWizard.js';
        import { supabase } from './src/shared/config/supabase.js';
        import { authErrorHandler } from './src/shared/services/authErrorHandler.js';
        import { UserFeedbackSystem } from './src/shared/services/userFeedbackSystem.js';
        import { connectionMonitor } from './src/shared/services/connectionMonitor.js';

        // Make available globally
        window.authService = authService;
        window.supabase = supabase;
        window.authErrorHandler = authErrorHandler;
        
        // Initialize enhanced error handling
        const feedbackSystem = new UserFeedbackSystem();
        window.feedbackSystem = feedbackSystem;

        // Enhanced message function using UserFeedbackSystem
        function showMessage(text, type = 'info') {
            if (type === 'success') {
                feedbackSystem.showSuccess(text);
            } else if (type === 'error') {
                feedbackSystem.showError(text);
            } else {
                // Fallback to original implementation for info/warning
                const colors = {
                    info: 'auth-info-box auth-info-box-info',
                    warning: 'auth-info-box auth-info-box-warning'
                };

                const msg = document.createElement('div');
                msg.className = `${colors[type]} auth-mb-4`;
                msg.innerHTML = `<p class="auth-text">${text}</p>`;
                document.getElementById('messages').appendChild(msg);
                
                setTimeout(() => msg.remove(), 5000);
            }
        }

        // Update status
        function updateStatus() {
            // Supabase status
            document.getElementById('supabase-status').innerHTML = supabase 
                ? '<span style="color: #10B981;">✅ Configurado</span>'
                : '<span style="color: #EF4444;">❌ No configurado</span>';

            // OAuth status (check env vars)
            const hasGoogle = import.meta.env.VITE_GOOGLE_CLIENT_ID && 
                             import.meta.env.VITE_GOOGLE_CLIENT_ID !== 'your_google_client_id_here';
            const hasGitHub = import.meta.env.VITE_GITHUB_CLIENT_ID && 
                             import.meta.env.VITE_GITHUB_CLIENT_ID !== 'your_github_client_id_here';

            document.getElementById('google-status').innerHTML = hasGoogle 
                ? '<span style="color: #10B981;">✅ Configurado</span>'
                : '<span style="color: #F59E0B;">⚠️ Opcional</span>';

            document.getElementById('github-status').innerHTML = hasGitHub 
                ? '<span style="color: #10B981;">✅ Configurado</span>'
                : '<span style="color: #F59E0B;">⚠️ Opcional</span>';

            // Auth status
            const isAuth = authService.isAuthenticated();
            document.getElementById('auth-status').innerHTML = isAuth
                ? '<span style="color: #10B981;">✅ Sí</span>'
                : '<span style="color: #EF4444;">❌ No</span>';

            const isNew = authService.isNewUser();
            document.getElementById('new-user-status').innerHTML = isNew
                ? '<span style="color: #F59E0B;">⚠️ Sí</span>'
                : '<span style="color: #EF4444;">❌ No</span>';

            const onboardingDone = localStorage.getItem('onboarding_completed') === 'true';
            document.getElementById('onboarding-status').innerHTML = onboardingDone
                ? '<span style="color: #10B981;">✅ Completado</span>'
                : '<span style="color: #EF4444;">❌ Pendiente</span>';
        }

        // Quick test functions with enhanced error handling
        document.getElementById('quick-register').addEventListener('click', async () => {
            const testEmail = `test${Date.now()}@anclora.com`;
            const testPassword = 'test123456';
            const testName = 'Usuario Test';

            feedbackSystem.showLoading('register', `Registrando usuario: ${testEmail}`);

            try {
                const user = await authService.register(testName, testEmail, testPassword);
                feedbackSystem.hideLoading();
                showMessage('✅ Registro exitoso! Ahora puedes hacer login.', 'success');
                
                // Auto-fill login form
                document.getElementById('login-email').value = testEmail;
                document.getElementById('login-password').value = testPassword;
                
                updateStatus();
            } catch (error) {
                feedbackSystem.hideLoading();
                const processedError = authErrorHandler.handleError(error, { 
                    operation: 'register',
                    language: 'es'
                });
                
                feedbackSystem.showError(processedError.type, {
                    canRetry: processedError.canRetry,
                    retryCallback: processedError.canRetry ? () => {
                        document.getElementById('quick-register').click();
                    } : null
                });
            }
        });

        document.getElementById('quick-login').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('⚠️ Primero haz el registro rápido o completa email/password', 'warning');
                return;
            }

            feedbackSystem.showLoading('login');

            try {
                await authService.login(email, password);
                feedbackSystem.hideLoading();
                showMessage('✅ Login exitoso!', 'success');
                updateStatus();

                // Auto-trigger onboarding if new user
                if (authService.isNewUser()) {
                    setTimeout(() => {
                        showMessage('🚀 Abriendo onboarding automáticamente...', 'info');
                        onboardingWizard.open();
                    }, 2000);
                }
            } catch (error) {
                feedbackSystem.hideLoading();
                const processedError = authErrorHandler.handleError(error, { 
                    operation: 'login',
                    language: 'es'
                });
                
                feedbackSystem.showError(processedError.type, {
                    canRetry: processedError.canRetry,
                    retryCallback: processedError.canRetry ? () => {
                        document.getElementById('quick-login').click();
                    } : null
                });
            }
        });

        document.getElementById('quick-onboarding').addEventListener('click', () => {
            onboardingWizard.open();
        });

        // Manual forms
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            try {
                await authService.register(name, email, password);
                showMessage('✅ Registro exitoso!', 'success');
                updateStatus();
            } catch (error) {
                showMessage(`❌ Error: ${error.message}`, 'error');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await authService.login(email, password);
                showMessage('✅ Login exitoso!', 'success');
                updateStatus();
            } catch (error) {
                showMessage(`❌ Error: ${error.message}`, 'error');
            }
        });

        // OAuth buttons
        document.getElementById('google-btn').addEventListener('click', async () => {
            try {
                await authService.loginWithGoogle();
                showMessage('🔍 Redirigiendo a Google...', 'info');
            } catch (error) {
                showMessage(`❌ Error Google: ${error.message}`, 'error');
            }
        });

        document.getElementById('github-btn').addEventListener('click', async () => {
            try {
                await authService.loginWithGitHub();
                showMessage('🐙 Redirigiendo a GitHub...', 'info');
            } catch (error) {
                showMessage(`❌ Error GitHub: ${error.message}`, 'error');
            }
        });

        // Action buttons
        document.getElementById('test-onboarding').addEventListener('click', () => {
            onboardingWizard.open();
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await authService.logout();
                showMessage('✅ Sesión cerrada', 'success');
                updateStatus();
            } catch (error) {
                showMessage(`❌ Error logout: ${error.message}`, 'error');
            }
        });

        document.getElementById('reset-data').addEventListener('click', () => {
            localStorage.clear();
            showMessage('🔄 Datos locales limpiados', 'info');
            updateStatus();
        });

        document.getElementById('check-db').addEventListener('click', async () => {
            if (!supabase) {
                showMessage('❌ Supabase no configurado', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.from('users').select('count');
                if (error) throw error;
                showMessage('✅ Conexión a base de datos OK', 'success');
            } catch (error) {
                showMessage(`❌ Error DB: ${error.message}`, 'error');
            }
        });

        // Error simulation event listeners
        document.getElementById('test-network-error').addEventListener('click', () => {
            const networkError = new Error('Network request failed');
            networkError.name = 'NetworkError';
            feedbackSystem.showError(networkError, {
                canRetry: true,
                retryCallback: () => {
                    showMessage('🔄 Reintentando operación...', 'info');
                    feedbackSystem.hideError();
                }
            });
        });

        document.getElementById('test-invalid-creds').addEventListener('click', () => {
            const credentialsError = new Error('Invalid login credentials');
            credentialsError.code = 'invalid_credentials';
            feedbackSystem.showError(credentialsError, {
                canRetry: true,
                retryCallback: () => {
                    showMessage('🔄 Reintentando con credenciales correctas...', 'info');
                    feedbackSystem.hideError();
                }
            });
        });

        document.getElementById('test-user-exists').addEventListener('click', () => {
            const userExistsError = new Error('User already registered');
            userExistsError.code = 'user_already_registered';
            feedbackSystem.showError(userExistsError, {
                canRetry: false
            });
        });

        document.getElementById('test-weak-password').addEventListener('click', () => {
            const weakPasswordError = new Error('Password too weak');
            weakPasswordError.code = 'weak_password';
            feedbackSystem.showError(weakPasswordError, {
                canRetry: true,
                retryCallback: () => {
                    showMessage('🔄 Intenta con una contraseña más fuerte...', 'info');
                    feedbackSystem.hideError();
                }
            });
        });

        document.getElementById('test-connectivity').addEventListener('click', async () => {
            showMessage('🌐 Probando conectividad...', 'info');
            
            try {
                const result = await connectionMonitor.isSupabaseAvailable();
                if (result.available) {
                    showMessage(`✅ Conectividad OK - Latencia: ${result.latency}ms`, 'success');
                } else {
                    showMessage(`❌ Sin conectividad - ${result.error?.message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                showMessage(`❌ Error al probar conectividad: ${error.message}`, 'error');
            }
        });

        document.getElementById('clear-all-errors').addEventListener('click', () => {
            feedbackSystem.clearAll();
            showMessage('✨ Todos los errores limpiados', 'info');
        });

        // Initialize connection monitoring
        connectionMonitor.startMonitoring();

        // Initial status
        updateStatus();
        setInterval(updateStatus, 3000);

        // Welcome message
        if (supabase) {
            showMessage('✅ Sistema listo! Usa "Prueba Rápida" para probar todo el flujo.', 'success');
        } else {
            showMessage('⚠️ Supabase no configurado. Revisa el archivo .env', 'warning');
        }
    </script>