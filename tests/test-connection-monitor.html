<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connection Monitor - Anclora</title>
    <link rel="stylesheet" href="src/shared/styles/auth-theme.css">
</head>
<body class="auth-page">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-[#2EAFC4]">
            Connection Monitor Test
        </h1>

        <div class="max-w-4xl mx-auto space-y-6">
            <!-- Connection Status Display -->
            <div class="bg-[#202837] rounded-lg p-6 border border-[#2EAFC4]/30">
                <h2 class="text-xl font-semibold mb-4 text-[#F6F7F9]">Connection Status</h2>
                <div id="connection-status" class="space-y-2">
                    <div class="text-gray-400">Loading...</div>
                </div>
            </div>

            <!-- Test Controls -->
            <div class="bg-[#202837] rounded-lg p-6 border border-[#2EAFC4]/30">
                <h2 class="text-xl font-semibold mb-4 text-[#F6F7F9]">Test Controls</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="start-monitoring" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        Start Monitoring
                    </button>
                    <button id="stop-monitoring" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                        Stop Monitoring
                    </button>
                    <button id="check-health" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                        Check Health
                    </button>
                    <button id="measure-latency" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                        Measure Latency
                    </button>
                </div>
            </div>

            <!-- Test Results -->
            <div class="bg-[#202837] rounded-lg p-6 border border-[#2EAFC4]/30">
                <h2 class="text-xl font-semibold mb-4 text-[#F6F7F9]">Test Results</h2>
                <div id="test-results" class="space-y-2 text-sm font-mono">
                    <div class="text-gray-400">No tests run yet...</div>
                </div>
            </div>

            <!-- Connection Indicator Test -->
            <div class="bg-[#202837] rounded-lg p-6 border border-[#2EAFC4]/30">
                <h2 class="text-xl font-semibold mb-4 text-[#F6F7F9]">Connection Indicator Test</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="show-indicator" class="px-4 py-2 bg-[#2EAFC4] hover:bg-[#2EAFC4]/80 rounded-lg transition-colors text-[#162032] font-semibold">
                        Show Indicator
                    </button>
                    <button id="hide-indicator" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">
                        Hide Indicator
                    </button>
                    <button id="simulate-disconnect" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg transition-colors">
                        Simulate Disconnect
                    </button>
                    <button id="simulate-connect" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        Simulate Connect
                    </button>
                </div>
            </div>

            <!-- Auth Modal Test -->
            <div class="bg-[#202837] rounded-lg p-6 border border-[#2EAFC4]/30">
                <h2 class="text-xl font-semibold mb-4 text-[#F6F7F9]">Auth Modal with Connection Monitoring</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="open-login-modal" class="px-4 py-2 bg-[#2EAFC4] hover:bg-[#2EAFC4]/80 rounded-lg transition-colors text-[#162032] font-semibold">
                        Open Login Modal
                    </button>
                    <button id="open-register-modal" class="px-4 py-2 bg-[#FFC979] hover:bg-[#FFC979]/80 rounded-lg transition-colors text-[#162032] font-semibold">
                        Open Register Modal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { connectionMonitor, CONNECTION_STATUS } from './src/shared/services/connectionMonitor.js';
        import { ConnectionStatusIndicator } from './src/shared/components/ConnectionStatusIndicator.js';
        import { authModalVanilla } from './src/shared/components/AuthModalVanilla.js';

        let indicator = null;

        // Update connection status display
        function updateStatusDisplay() {
            const status = connectionMonitor.getStatus();
            const statusElement = document.getElementById('connection-status');
            
            statusElement.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>Status:</strong> <span class="text-[#2EAFC4]">${status.status}</span></div>
                    <div><strong>Latency:</strong> <span class="text-[#FFC979]">${status.latency || 'N/A'}ms</span></div>
                    <div><strong>Quality:</strong> <span class="text-green-400">${status.quality || 'N/A'}</span></div>
                    <div><strong>Monitoring:</strong> <span class="${status.isMonitoring ? 'text-green-400' : 'text-red-400'}">${status.isMonitoring ? 'Active' : 'Inactive'}</span></div>
                    <div><strong>Last Check:</strong> <span class="text-gray-300">${status.lastCheck || 'Never'}</span></div>
                    <div><strong>Supabase:</strong> <span class="${status.supabaseEnabled ? 'text-green-400' : 'text-yellow-400'}">${status.supabaseEnabled ? 'Enabled' : 'Mock Mode'}</span></div>
                </div>
            `;
        }

        // Add test result
        function addTestResult(message, type = 'info') {
            const resultsElement = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            }[type] || 'text-gray-400';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `${colorClass} border-l-2 border-current pl-2`;
            resultDiv.innerHTML = `[${timestamp}] ${message}`;
            
            resultsElement.appendChild(resultDiv);
            resultsElement.scrollTop = resultsElement.scrollHeight;
        }

        // Setup event listeners
        connectionMonitor.onConnectionChange('statusChange', (event) => {
            updateStatusDisplay();
            addTestResult(`Status changed: ${event.from} â†’ ${event.to}`, 'info');
        });

        connectionMonitor.onConnectionChange('connectivityCheck', (result) => {
            updateStatusDisplay();
            addTestResult(`Connectivity check: ${result.status} (${result.latency || 'N/A'}ms)`, 
                result.available ? 'success' : 'warning');
        });

        // Button event listeners
        document.getElementById('start-monitoring').addEventListener('click', () => {
            connectionMonitor.startMonitoring();
            addTestResult('Started connection monitoring', 'success');
            updateStatusDisplay();
        });

        document.getElementById('stop-monitoring').addEventListener('click', () => {
            connectionMonitor.stopMonitoring();
            addTestResult('Stopped connection monitoring', 'warning');
            updateStatusDisplay();
        });

        document.getElementById('check-health').addEventListener('click', async () => {
            addTestResult('Checking Supabase health...', 'info');
            try {
                const result = await connectionMonitor.isSupabaseAvailable();
                addTestResult(`Health check result: ${result.available ? 'Available' : 'Unavailable'} (${result.latency || 'N/A'}ms)`, 
                    result.available ? 'success' : 'error');
            } catch (error) {
                addTestResult(`Health check error: ${error.message}`, 'error');
            }
        });

        document.getElementById('measure-latency').addEventListener('click', async () => {
            addTestResult('Measuring connection latency...', 'info');
            try {
                const result = await connectionMonitor.getConnectionLatency();
                if (result.success) {
                    addTestResult(`Latency: avg=${result.latency.average}ms, min=${result.latency.minimum}ms, max=${result.latency.maximum}ms, quality=${result.quality}`, 'success');
                } else {
                    addTestResult(`Latency measurement failed: ${result.error?.message}`, 'error');
                }
            } catch (error) {
                addTestResult(`Latency measurement error: ${error.message}`, 'error');
            }
        });

        document.getElementById('show-indicator').addEventListener('click', () => {
            if (!indicator) {
                indicator = new ConnectionStatusIndicator({
                    position: 'top-right',
                    showLatency: true,
                    autoHide: false
                });
            }
            indicator.forceShow();
            addTestResult('Connection indicator shown', 'info');
        });

        document.getElementById('hide-indicator').addEventListener('click', () => {
            if (indicator) {
                indicator.hide();
                addTestResult('Connection indicator hidden', 'info');
            }
        });

        document.getElementById('simulate-disconnect').addEventListener('click', () => {
            // This would require mocking the connection monitor
            addTestResult('Disconnect simulation not implemented (would require mocking)', 'warning');
        });

        document.getElementById('simulate-connect').addEventListener('click', () => {
            // This would require mocking the connection monitor
            addTestResult('Connect simulation not implemented (would require mocking)', 'warning');
        });

        document.getElementById('open-login-modal').addEventListener('click', () => {
            authModalVanilla.open('login');
            addTestResult('Opened login modal with connection monitoring', 'info');
        });

        document.getElementById('open-register-modal').addEventListener('click', () => {
            authModalVanilla.open('register');
            addTestResult('Opened register modal with connection monitoring', 'info');
        });

        // Initialize
        updateStatusDisplay();
        addTestResult('Connection monitor test page loaded', 'success');
        
        // Auto-start monitoring for demo
        setTimeout(() => {
            connectionMonitor.startMonitoring();
            addTestResult('Auto-started connection monitoring', 'info');
        }, 1000);
    </script>
</body>
</html>