<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico: Email de Recuperaci√≥n No Llega</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .status-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .status-success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .status-warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .status-error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .diagnostic-item {
            display: flex;
            align-items: center;
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .diagnostic-icon {
            width: 24px;
            height: 24px;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0.5rem;
        }

        .btn-primary {
            background: #0ea5e9;
            color: white;
        }

        .btn-primary:hover {
            background: #0284c7;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .results {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .checklist input[type="checkbox"] {
            margin-right: 0.75rem;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico: Email de Recuperaci√≥n</h1>
            <p>Vamos a diagnosticar por qu√© no te llega el email de recuperaci√≥n de contrase√±a</p>
        </div>

        <!-- Paso 1: Informaci√≥n b√°sica -->
        <div class="status-card">
            <h2>üìã Paso 1: Informaci√≥n del problema</h2>
            <div>
                <label for="email-input">Email que usaste para recuperar:</label>
                <input type="email" id="email-input" placeholder="tu@email.com" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
            <div>
                <label for="time-input">¬øHace cu√°nto tiempo intentaste? (minutos):</label>
                <input type="number" id="time-input" placeholder="5" min="1" max="120" style="width: 100px; padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
            <button class="btn btn-primary" onclick="startDiagnosis()">üöÄ Iniciar Diagn√≥stico</button>
        </div>

        <!-- Paso 2: Verificaciones autom√°ticas -->
        <div id="auto-checks" class="status-card hidden">
            <h2>üîß Paso 2: Verificaciones autom√°ticas</h2>
            <div id="auto-checks-results">
                <div class="loading">
                    <div class="spinner"></div>
                    Ejecutando verificaciones autom√°ticas...
                </div>
            </div>
        </div>

        <!-- Paso 3: Checklist manual -->
        <div id="manual-checks" class="status-card hidden">
            <h2>‚úÖ Paso 3: Verificaci√≥n manual</h2>
            <p>Por favor, revisa estos elementos en tu email:</p>
            <ul class="checklist">
                <li>
                    <input type="checkbox" id="check-inbox">
                    <label for="check-inbox">He revisado mi bandeja de entrada principal</label>
                </li>
                <li>
                    <input type="checkbox" id="check-spam">
                    <label for="check-spam">He revisado la carpeta de SPAM/Correo no deseado</label>
                </li>
                <li>
                    <input type="checkbox" id="check-promotions">
                    <label for="check-promotions">He revisado carpetas como Promociones, Actualizaciones, Social (Gmail)</label>
                </li>
                <li>
                    <input type="checkbox" id="check-search">
                    <label for="check-search">He buscado "Anclora", "recuperaci√≥n" o "noreply@supabase.co"</label>
                </li>
                <li>
                    <input type="checkbox" id="check-email-correct">
                    <label for="check-email-correct">He verificado que el email est√© escrito correctamente</label>
                </li>
            </ul>
            <button class="btn btn-primary" onclick="analyzeChecklist()">üìä Analizar Resultados</button>
        </div>

        <!-- Paso 4: Diagn√≥stico t√©cnico -->
        <div id="technical-diagnosis" class="status-card hidden">
            <h2>üî¨ Paso 4: Diagn√≥stico t√©cnico</h2>
            <button class="btn btn-warning" onclick="runTechnicalDiagnosis()">üß™ Ejecutar Prueba T√©cnica</button>
            <div id="technical-results"></div>
        </div>

        <!-- Resultados y recomendaciones -->
        <div id="final-results" class="results hidden">
            <h2>üìã Diagn√≥stico Completo</h2>
            <div id="diagnosis-summary"></div>
            <div id="recommendations"></div>
        </div>
    </div>

    <script type="module">
        let diagnosticData = {
            email: '',
            timeAgo: 0,
            autoChecks: {},
            manualChecks: {},
            technicalResults: {}
        };

        window.startDiagnosis = function() {
            const email = document.getElementById('email-input').value;
            const timeAgo = parseInt(document.getElementById('time-input').value) || 5;

            if (!email) {
                alert('Por favor ingresa tu email');
                return;
            }

            diagnosticData.email = email;
            diagnosticData.timeAgo = timeAgo;

            // Mostrar verificaciones autom√°ticas
            document.getElementById('auto-checks').classList.remove('hidden');
            
            // Ejecutar verificaciones autom√°ticas
            setTimeout(runAutoChecks, 1000);
        };

        async function runAutoChecks() {
            const resultsDiv = document.getElementById('auto-checks-results');
            
            try {
                // Verificar configuraci√≥n de Supabase
                const supabaseConfigured = !!(import.meta.env?.VITE_SUPABASE_URL && import.meta.env?.VITE_SUPABASE_ANON_KEY);
                
                // Verificar conectividad
                let connectivityOk = false;
                try {
                    if (import.meta.env?.VITE_SUPABASE_URL) {
                        const response = await fetch(import.meta.env.VITE_SUPABASE_URL + '/rest/v1/', {
                            method: 'HEAD',
                            timeout: 5000
                        });
                        connectivityOk = response.ok;
                    }
                } catch (error) {
                    connectivityOk = false;
                }

                // Verificar formato de email
                const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(diagnosticData.email);

                // Verificar tiempo transcurrido
                const timeAppropriate = diagnosticData.timeAgo >= 2 && diagnosticData.timeAgo <= 60;

                diagnosticData.autoChecks = {
                    supabaseConfigured,
                    connectivityOk,
                    emailValid,
                    timeAppropriate
                };

                // Mostrar resultados
                resultsDiv.innerHTML = `
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${supabaseConfigured ? '‚úÖ' : '‚ùå'}</div>
                        <div>
                            <strong>Configuraci√≥n de Supabase:</strong> 
                            ${supabaseConfigured ? 'Configurado correctamente' : 'No configurado o incompleto'}
                        </div>
                    </div>
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${connectivityOk ? '‚úÖ' : '‚ùå'}</div>
                        <div>
                            <strong>Conectividad:</strong> 
                            ${connectivityOk ? 'Conexi√≥n exitosa con Supabase' : 'No se puede conectar con Supabase'}
                        </div>
                    </div>
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${emailValid ? '‚úÖ' : '‚ùå'}</div>
                        <div>
                            <strong>Formato de email:</strong> 
                            ${emailValid ? 'Formato v√°lido' : 'Formato inv√°lido'}
                        </div>
                    </div>
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${timeAppropriate ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div>
                            <strong>Tiempo transcurrido:</strong> 
                            ${timeAppropriate ? `${diagnosticData.timeAgo} minutos (apropiado)` : 
                              diagnosticData.timeAgo < 2 ? 'Muy poco tiempo, espera al menos 2-3 minutos' :
                              'Demasiado tiempo, puede haber un problema'}
                        </div>
                    </div>
                `;

                // Mostrar checklist manual
                document.getElementById('manual-checks').classList.remove('hidden');

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">‚ùå</div>
                        <div>
                            <strong>Error en verificaciones autom√°ticas:</strong> ${error.message}
                        </div>
                    </div>
                `;
                
                // A√∫n as√≠ mostrar checklist manual
                document.getElementById('manual-checks').classList.remove('hidden');
            }
        }

        window.analyzeChecklist = function() {
            const checks = {
                inbox: document.getElementById('check-inbox').checked,
                spam: document.getElementById('check-spam').checked,
                promotions: document.getElementById('check-promotions').checked,
                search: document.getElementById('check-search').checked,
                emailCorrect: document.getElementById('check-email-correct').checked
            };

            diagnosticData.manualChecks = checks;

            // Mostrar diagn√≥stico t√©cnico
            document.getElementById('technical-diagnosis').classList.remove('hidden');

            // Si no ha revisado spam, mostrar alerta inmediata
            if (!checks.spam) {
                alert('‚ö†Ô∏è IMPORTANTE: No has revisado tu carpeta de SPAM. Esta es la causa m√°s com√∫n de emails "perdidos". Por favor rev√≠sala antes de continuar.');
            }
        };

        window.runTechnicalDiagnosis = async function() {
            const resultsDiv = document.getElementById('technical-results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Ejecutando prueba t√©cnica...</div>';

            try {
                // Importar authService din√°micamente
                const { authService } = await import('./src/shared/services/authService.js');
                
                console.log('üî¨ Iniciando diagn√≥stico t√©cnico para:', diagnosticData.email);

                // Ejecutar resetPassword con diagn√≥sticos completos
                const result = await authService.resetPassword(diagnosticData.email, {
                    language: 'es',
                    enableDiagnostics: true
                });

                diagnosticData.technicalResults = result;

                // Mostrar resultados t√©cnicos
                resultsDiv.innerHTML = `
                    <div class="code-block">
                        <strong>Resultado de la prueba t√©cnica:</strong><br>
                        ${JSON.stringify(result, null, 2)}
                    </div>
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${result.success ? '‚úÖ' : '‚ùå'}</div>
                        <div>
                            <strong>Env√≠o de email:</strong> 
                            ${result.success ? 'Exitoso seg√∫n Supabase' : `Error: ${result.error?.message}`}
                        </div>
                    </div>
                `;

                // Mostrar resultados finales
                showFinalResults();

            } catch (error) {
                console.error('Error en diagn√≥stico t√©cnico:', error);
                
                resultsDiv.innerHTML = `
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">‚ùå</div>
                        <div>
                            <strong>Error en prueba t√©cnica:</strong> ${error.message}
                        </div>
                    </div>
                `;

                diagnosticData.technicalResults = {
                    success: false,
                    error: { message: error.message, type: 'TECHNICAL_ERROR' }
                };

                // A√∫n as√≠ mostrar resultados finales
                showFinalResults();
            }
        };

        function showFinalResults() {
            const finalDiv = document.getElementById('final-results');
            const summaryDiv = document.getElementById('diagnosis-summary');
            const recommendationsDiv = document.getElementById('recommendations');

            // Analizar todos los datos
            const analysis = analyzeDiagnosticData();

            summaryDiv.innerHTML = `
                <h3>üìä Resumen del Diagn√≥stico</h3>
                <div class="status-card ${analysis.severity === 'high' ? 'status-error' : 
                                        analysis.severity === 'medium' ? 'status-warning' : 'status-success'}">
                    <h4>${analysis.title}</h4>
                    <p>${analysis.description}</p>
                    <p><strong>Causa m√°s probable:</strong> ${analysis.mostLikelyCause}</p>
                </div>
            `;

            recommendationsDiv.innerHTML = `
                <h3>üí° Recomendaciones Espec√≠ficas</h3>
                ${analysis.recommendations.map(rec => `
                    <div class="diagnostic-item">
                        <div class="diagnostic-icon">${rec.priority === 'high' ? 'üö®' : rec.priority === 'medium' ? '‚ö†Ô∏è' : 'üí°'}</div>
                        <div>
                            <strong>${rec.title}:</strong> ${rec.description}
                            ${rec.action ? `<br><button class="btn btn-primary" onclick="${rec.action}">${rec.actionText}</button>` : ''}
                        </div>
                    </div>
                `).join('')}
            `;

            finalDiv.classList.remove('hidden');
        }

        function analyzeDiagnosticData() {
            const { autoChecks, manualChecks, technicalResults } = diagnosticData;

            // Determinar la causa m√°s probable
            let mostLikelyCause = 'Desconocida';
            let severity = 'low';
            let title = 'Diagn√≥stico Completado';
            let description = 'Se ha completado el an√°lisis.';
            let recommendations = [];

            // An√°lisis de verificaciones autom√°ticas
            if (!autoChecks.supabaseConfigured) {
                mostLikelyCause = 'Configuraci√≥n de Supabase incompleta';
                severity = 'high';
                title = 'Problema de Configuraci√≥n';
                description = 'El sistema no est√° configurado correctamente para enviar emails.';
                recommendations.push({
                    priority: 'high',
                    title: 'Configurar Supabase',
                    description: 'Verifica que las variables VITE_SUPABASE_URL y VITE_SUPABASE_ANON_KEY est√©n configuradas.',
                    action: 'window.open("https://supabase.com/docs/guides/getting-started")',
                    actionText: 'Ver Documentaci√≥n'
                });
            } else if (!autoChecks.connectivityOk) {
                mostLikelyCause = 'Problemas de conectividad con Supabase';
                severity = 'high';
                title = 'Problema de Conectividad';
                description = 'No se puede conectar con el servicio de Supabase.';
                recommendations.push({
                    priority: 'high',
                    title: 'Verificar Conectividad',
                    description: 'Revisa tu conexi√≥n a internet y el estado de Supabase.',
                    action: 'window.open("https://status.supabase.com")',
                    actionText: 'Ver Estado de Supabase'
                });
            } else if (!autoChecks.emailValid) {
                mostLikelyCause = 'Formato de email inv√°lido';
                severity = 'medium';
                title = 'Email Inv√°lido';
                description = 'El formato del email no es v√°lido.';
                recommendations.push({
                    priority: 'high',
                    title: 'Corregir Email',
                    description: 'Verifica que el email est√© escrito correctamente.'
                });
            } else if (technicalResults.success && !manualChecks.spam) {
                mostLikelyCause = 'Email en carpeta de SPAM';
                severity = 'medium';
                title = 'Probable Email en SPAM';
                description = 'El email se envi√≥ correctamente pero no has revisado la carpeta de spam.';
                recommendations.push({
                    priority: 'high',
                    title: 'Revisar SPAM',
                    description: 'Revisa tu carpeta de spam/correo no deseado. Esta es la causa m√°s com√∫n.',
                    action: 'alert("Ve a tu email y revisa la carpeta de SPAM o Correo no deseado")',
                    actionText: 'Ir a Email'
                });
            } else if (technicalResults.success) {
                mostLikelyCause = 'Email enviado correctamente - revisar todas las carpetas';
                severity = 'low';
                title = 'Email Enviado Exitosamente';
                description = 'El sistema confirma que el email se envi√≥. Debe estar en alguna carpeta de tu email.';
                recommendations.push({
                    priority: 'medium',
                    title: 'B√∫squeda Exhaustiva',
                    description: 'Busca "noreply@supabase.co" o "Anclora" en todo tu email.'
                });
            } else if (technicalResults.error) {
                mostLikelyCause = `Error del sistema: ${technicalResults.error.type}`;
                severity = 'high';
                title = 'Error del Sistema';
                description = `Error t√©cnico: ${technicalResults.error.message}`;
                recommendations.push({
                    priority: 'high',
                    title: 'Contactar Soporte',
                    description: 'Hay un problema t√©cnico que requiere asistencia.',
                    action: `contactSupport('${diagnosticData.email}', '${technicalResults.error.type}')`,
                    actionText: 'Contactar Soporte'
                });
            }

            // Recomendaciones adicionales basadas en el tiempo
            if (diagnosticData.timeAgo < 2) {
                recommendations.unshift({
                    priority: 'medium',
                    title: 'Esperar M√°s Tiempo',
                    description: 'Han pasado menos de 2 minutos. Los emails pueden tardar hasta 5 minutos en llegar.'
                });
            }

            // Recomendaciones generales
            recommendations.push({
                priority: 'low',
                title: 'Prevenci√≥n Futura',
                description: 'Agrega noreply@supabase.co a tus contactos para evitar que vaya a spam.'
            });

            return {
                mostLikelyCause,
                severity,
                title,
                description,
                recommendations
            };
        }

        // Funci√≥n para contactar soporte
        window.contactSupport = function(email, errorType) {
            const subject = encodeURIComponent('Diagn√≥stico: No llega email de recuperaci√≥n');
            const body = encodeURIComponent(`
Hola,

He ejecutado el diagn√≥stico autom√°tico y no me llega el email de recuperaci√≥n.

DATOS DEL DIAGN√ìSTICO:
- Email: ${email}
- Tiempo transcurrido: ${diagnosticData.timeAgo} minutos
- Error t√©cnico: ${errorType}

VERIFICACIONES AUTOM√ÅTICAS:
${JSON.stringify(diagnosticData.autoChecks, null, 2)}

VERIFICACIONES MANUALES:
${JSON.stringify(diagnosticData.manualChecks, null, 2)}

RESULTADO T√âCNICO:
${JSON.stringify(diagnosticData.technicalResults, null, 2)}

INFORMACI√ìN DEL SISTEMA:
- Navegador: ${navigator.userAgent}
- Hora: ${new Date().toLocaleString()}
- URL: ${window.location.href}

Por favor, ay√∫denme a resolver este problema.

Gracias.
            `);
            
            window.open(`mailto:soporte@anclora.com?subject=${subject}&body=${body}`);
        };

        // Mostrar informaci√≥n inicial
        console.log('üîç Diagn√≥stico de Email de Recuperaci√≥n iniciado');
        console.log('Configuraci√≥n actual:', {
            supabaseUrl: import.meta.env?.VITE_SUPABASE_URL,
            hasAnonKey: !!import.meta.env?.VITE_SUPABASE_ANON_KEY
        });
    </script>
</body>
</html>